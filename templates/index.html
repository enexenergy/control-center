<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enex Control Center</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .card {
            position: relative;
        }

        .drag-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 255, 0, 0.2);
            border: 2px dashed #0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            pointer-events: none;
            border-radius: 12px;
            backdrop-filter: blur(2px);
        }

        .btn-secondary {
            background-color: #444;
        }

        .btn-secondary:hover {
            background-color: #666;
        }
    </style>
</head>

<body>

    <header>
        <div class="header-container">
            <img src="{{ url_for('static', filename='logo_enex.png') }}" alt="ENEX Logo" class="header-logo">
            <div>
                <h1>Enex EMS</h1>
                <div class="subtitle">Centro de Control</div>
            </div>
        </div>
    </header>

    <main>
        <!-- Section: Scripts -->
        <h2 class="section-title">Scripts</h2>
        <div class="cards-grid">
            <!-- Card 1: Omie Holded -->
            <!-- Card 1: Omie Holded -->
            <div class="card" id="card-omie">
                <div>
                    <div class="card-icon">‚ö°</div>
                    <h2>OMIE</h2>
                    <p>Arrastra el ZIP aqu√≠ o haz clic en "Subir" para procesar datos.</p>
                </div>
                <div style="display: flex; gap: 10px; flex-direction: column; margin-top: 10px;">
                    <input type="file" id="file-omie" accept=".zip" style="display:none"
                        onchange="handleFileSelect('omie_holded.py', this.files)">
                    <button class="btn" onclick="document.getElementById('file-omie').click()">Subir ZIP y
                        Procesar</button>
                    <button class="btn btn-secondary" onclick="runScript('omie_holded.py')">Ejecutar (Buscar en
                        Descargas)</button>
                </div>
                <!-- Overlay for drag feedback -->
                <div id="drag-overlay-omie" class="drag-overlay" style="display:none;">üìÇ Soltar para Procesar</div>
            </div>

            <!-- Card 2: Divakia ATR -->
            <div class="card">
                <div>
                    <div class="card-icon">üìä</div>
                    <h2>ATR</h2>
                    <p>Procesamiento de archivos ATR y gesti√≥n de datos Divakia.</p>
                </div>
                <button class="btn" onclick="runScript('divakia_atr.py')">Ejecutar</button>
            </div>

            <!-- Card 3: Facturas Emitidas -->
            <div class="card">
                <div>
                    <div class="card-icon">üßæ</div>
                    <h2>Facturas Emitidas</h2>
                    <p>Generaci√≥n y control de facturas emitidas.</p>
                </div>
                <button class="btn" onclick="runScript('facturas_emitidas.py')">Ejecutar</button>
            </div>
        </div>

        <!-- Section: Pages -->
        <h2 class="section-title">Paneles de Visualizaci√≥n</h2>
        <div class="cards-grid">
            <!-- Card 4: Facturaci√≥n Graph -->
            <div class="card">
                <div>
                    <div class="card-icon">üìà</div>
                    <h2>Facturaci√≥n</h2>
                    <p>Ver gr√°ficas de ventas mensuales.</p>
                </div>
                <a href="/billing" class="btn"
                    style="text-decoration: none; display: inline-block; text-align: center;">Ver Dashboard</a>
            </div>

            <!-- Card 5: Ranking -->
            <div class="card">
                <div>
                    <div class="card-icon">üèÜ</div>
                    <h2>Ranking</h2>
                    <p>Ranking de comercializadoras y posici√≥n de ENEX.</p>
                </div>
                <a href="/ranking" class="btn"
                    style="text-decoration: none; display: inline-block; text-align: center;">Ver Ranking</a>
            </div>

            <!-- Card 6: Visualizador SIPS -->
            <div class="card">
                <div>
                    <div class="card-icon">üëÅÔ∏è</div>
                    <h2>Visualizador SIPS</h2>
                    <p>Consultar datos t√©cnicos y de consumo (CUPS).</p>
                </div>
                <a href="/sips" class="btn"
                    style="text-decoration: none; display: inline-block; text-align: center;">Ver Dashboard</a>
            </div>
        </div>

    </main>

    <!-- Modal Output -->
    <div id="output-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Ejecutando...</h3>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div id="output-area" class="output-container">Esperando inicio...</div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('output-modal');
        const outputArea = document.getElementById('output-area');
        const modalTitle = document.getElementById('modal-title');

        async function runScript(scriptName) {
            modal.style.display = 'flex';
            modalTitle.innerHTML = `Ejecutando ${scriptName} <div class="spinner"></div>`;
            outputArea.textContent = 'Iniciando proceso...';

            try {
                const response = await fetch(`/run/${scriptName}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                outputArea.textContent = '';
                let partialLine = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        if (partialLine) processLine(partialLine);
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = (partialLine + chunk).split('\n');

                    // The last element is the partial line for the next chunk
                    partialLine = lines.pop();

                    for (const line of lines) {
                        processLine(line);
                    }
                }

                modalTitle.textContent = `${scriptName} Finalizado`;

            } catch (error) {
                console.error("Execution error:", error);
                outputArea.textContent += `\n[FATAL ERROR] ${error.name}: ${error.message}`;
                if (error.stack) outputArea.textContent += `\n${error.stack}`;
                modalTitle.textContent = 'Error en Ejecuci√≥n';
            }
        }

        function processLine(line) {
            const tokenMarker = "__FILE_DOWNLOAD__;;";
            if (line.includes(tokenMarker)) {
                try {
                    const startIndex = line.indexOf(tokenMarker);
                    const relevantPart = line.substring(startIndex);
                    const parts = relevantPart.split(";;");
                    // 0: __FILE_DOWNLOAD__
                    // 1: filename
                    // 2: mime
                    // 3: base64
                    if (parts.length >= 4) {
                        const filename = parts[1];
                        const mime = parts[2];
                        const b64 = parts[3];
                        triggerDownload(filename, mime, b64);
                        outputArea.textContent += `\n[INFO] Descarga iniciada: ${filename}`;
                    }
                } catch (e) {
                    console.error("Download parsing error", e);
                    outputArea.textContent += `\n[ERROR] Fallo al procesar descarga: ${e.message}`;
                }
            } else {
                outputArea.textContent += line + "\n";
                outputArea.scrollTop = outputArea.scrollHeight;
            }
        }

        function triggerDownload(filename, mime, base64Data) {
            try {
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: mime });

                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(link.href);
            } catch (e) {
                console.error("Blob error", e);
                outputArea.textContent += `\n[ERROR] Fallo al crear archivo: ${e.message}`;
            }
        }

        // === UPLOAD LOGIC ===

        async function runUploadScript(scriptName, file) {
            modal.style.display = 'flex';
            modalTitle.innerHTML = `Subiendo y ejecutando ${scriptName}... <div class="spinner"></div>`;
            outputArea.textContent = 'Subiendo archivo...';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`/run-upload/${scriptName}`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                // Process stream exactly like runScript
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                outputArea.textContent = 'Archivo subido. Procesando...\n';
                let partialLine = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        if (partialLine) processLine(partialLine);
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = (partialLine + chunk).split('\n');
                    partialLine = lines.pop();

                    for (const line of lines) {
                        processLine(line);
                    }
                }

                modalTitle.textContent = `${scriptName} Finalizado`;
            } catch (error) {
                console.error("Upload Execution error:", error);
                outputArea.textContent += `\n[FATAL ERROR] ${error.name}: ${error.message}`;
                modalTitle.textContent = 'Error en Ejecuci√≥n';
            }
        }

        function handleFileSelect(scriptName, files) {
            if (files.length > 0) {
                runUploadScript(scriptName, files[0]);
            }
        }

        function setupDragAndDrop(cardId, overlayId, scriptName) {
            const card = document.getElementById(cardId);
            const overlay = document.getElementById(overlayId);

            if (!card || !overlay) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                card.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Highlight
            ['dragenter', 'dragover'].forEach(eventName => {
                card.addEventListener(eventName, () => overlay.style.display = 'flex', false);
            });

            // Unhighlight
            ['dragleave', 'drop'].forEach(eventName => {
                card.addEventListener(eventName, () => overlay.style.display = 'none', false);
            });

            card.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFileSelect(scriptName, files);
            }, false);
        }

        // Initialize D&D for OMIE
        document.addEventListener('DOMContentLoaded', () => {
            setupDragAndDrop('card-omie', 'drag-overlay-omie', 'omie_holded.py');
        });

        function closeModal() {
            modal.style.display = 'none';
        }

        // Close on click outside
        window.onclick = function (event) {
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>

</html>